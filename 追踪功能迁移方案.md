# ByteProject 追踪功能迁移到 AgentWorks 完整方案

> **最后更新**: 2025-12-23
> **当前阶段**: Phase 0 - 爬虫线上化验证
> **进度**: ✅✅✅ **核心验证完成！** 爬虫已在 ECS 成功运行，数据提取正常（播放量 15,145,375 等）

---

## 项目概述

将 ByteProject（kol_data 数据库）的**追踪功能**（日报、数据录入、效果监控）及**自动化配置能力**完整迁移到 AgentWorks（agentworks_db），同时将**本地爬虫能力线上化**。

### 核心目标

1. **爬虫能力线上化**：将截图套件从本地运行改为火山引擎容器服务
2. **自动化配置迁移**：复制 byteproject 的 automation_suite 配置页面到 AgentWorks
3. **追踪数据迁移**：将 works 的日报数据迁移到 collaborations 集合
4. **功能增强**：为未来扩展小红书/B站/快手等平台做准备
5. **两系统并行**：byteproject 继续保留运行

---

## 已确认的设计决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 日报数据存储 | **融合到 collaborations** | 简单、无性能问题（最大41KB/年） |
| 自动化集合 | **迁移到 agentworks_db** | kol_data 未来可能废弃 |
| 工作流管理 | **前端可视化配置** | 复制 automation_suite 能力 |
| 浏览器服务 | **ECS 云服务器（包年）** | ¥89/年，无限制，可扩展 |
| 告警通知 | 前端页面提示 | 用户指定 |
| 日报功能位置 | TrackingTab + Reports 模块 | 两者结合 |
| 已有数据迁移 | 由现有迁移产品完成 | 独立进行 |
| 实施范围 | 先日报，后续逐一实现全部 | 日报最重要 |
| 触发方式 | 定时+手动（线上化后再实现） | 项目级配置 |
| **滑块验证处理** | **超级鹰打码平台** | ~¥1/月，约24小时触发一次 |
| **最高优先级** | **先验证爬虫线上化可行性** | 最大不确定性 |

## 核心工作流（优先级排序）

| 工作流 | 输入 | 优先级 | 用途 |
|--------|------|--------|------|
| 获取合作视频当日播放量 | taskId | **P0** | 日报核心 |
| 获取合作视频14天后当日播放量 | videoId | **P0** | T14延迟数据 |
| 达人主页全面报告最新版 | xingtuId | **P1** | 达人截图报告 |
| 达人数据获取 | xingtuId | P2 | 达人信息抓取 |
| 达人报名截图 | xingtuId | P3 | 报名流程截图 |

> 未来目标：支持工作流拼接（组合任务），解决旧版设计问题

---

## Phase 0: 爬虫线上化验证（最高优先级）

### 技术选型

**最终方案**：ECS 云服务器（包年）

| 对比项 | veFaaS | VKE+VCI | ECS ✅ |
|--------|--------|---------|--------|
| 复杂任务（长图拼接） | 120s 超时风险 | 无限制 | **无限制** |
| 镜像大小 | ≤1GB 紧张 | 无限制 | **无限制** |
| 月费用 | ~¥50-100 | ~¥1,440+ | **~¥8** |
| 可扩展性 | 单一用途 | 复杂 | **可部署多服务** |
| 操作复杂度 | 低 | 高 | **中等** |

**选择理由**：
- 价格最优：¥89/年 = ¥7.4/月
- 无任何限制：镜像大小、执行时间
- 可扩展：后续可部署其他服务
- 易调试：可 SSH 直接登录排查问题

### 已购买的 ECS 实例信息

| 配置项 | 值 |
|--------|-----|
| 实例ID | ECS-e9Y8 |
| 地域 | cn-shanghai（华东2） |
| 规格 | 共享型 e-c1m2（2核4G） |
| 系统 | Ubuntu 22.04 |
| **公网IP** | **14.103.18.8** |
| 内网IP | 172.31.0.2 |
| 带宽 | 5 Mbps（按流量计费） |
| 购买时间 | 2025-12-23 |

### SSH 快捷连接配置（Mac）✅ 已配置

> **状态**：已于 2025-12-23 配置完成，可直接使用

**问题背景**：Mac OpenSSH 10.0 版本与 ECS 默认 SSH 配置存在兼容性问题，需要指定密钥交换算法。

**配置方法**（一次性执行）：
```bash
cat >> ~/.ssh/config << 'EOF'

Host ecs
    HostName 14.103.18.8
    User root
    KexAlgorithms +diffie-hellman-group14-sha256
    HostKeyAlgorithms +ssh-rsa
EOF
```

**配置后的使用方式**：
```bash
ssh ecs                                    # 连接服务器
scp 本地文件 ecs:/opt/puppeteer-executor/  # 上传文件
scp ecs:/远程文件 ./                       # 下载文件
```

**密码**：购买 ECS 时设置的 root 密码

**如果未配置快捷方式，使用完整命令**：
```bash
ssh -o KexAlgorithms=+diffie-hellman-group14-sha256 root@14.103.18.8
```

### ECS 部署教程（零基础）

#### Step 1: 购买 ECS 实例

1. 访问火山引擎控制台：https://console.volcengine.com/ecs
2. 点击"创建实例"
3. 配置选择：
   - **计费方式**：包年包月
   - **地域**：华东2（上海）或与你 MongoDB 同区
   - **规格**：通用型 g3i，2核4G
   - **镜像**：Ubuntu 22.04 或 CentOS 8
   - **系统盘**：40GB SSD
   - **公网带宽**：按流量计费，5Mbps
   - **时长**：1年（¥89）
4. 设置登录密码或 SSH 密钥
5. 确认购买

#### Step 2: 连接服务器

**方式一：火山引擎控制台（推荐新手）**
1. 在 ECS 实例列表，点击"远程连接"
2. 选择"Workbench 远程连接"
3. 输入密码登录

**方式二：本地终端 SSH**
```bash
ssh root@<你的ECS公网IP>
```

#### Step 3: 安装运行环境

复制以下命令到服务器执行：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Node.js 20 (LTS，支持到2026年)
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# 安装 Chromium 依赖
apt install -y chromium-browser fonts-wqy-zenhei

# 验证安装
node -v
chromium-browser --version
```

#### Step 4: 部署爬虫代码

```bash
# 创建工作目录
mkdir -p /opt/puppeteer-executor
cd /opt/puppeteer-executor

# 初始化项目
npm init -y
npm install puppeteer-core express dotenv

# 创建环境变量文件
cat > .env << 'EOF'
MONGO_URI=你的MongoDB连接串
CJY_USER=超级鹰用户名
CJY_PASS_MD5=密码MD5
CJY_SOFTID=软件ID
EOF
```

#### Step 5: 上传爬虫代码

从本地上传 `puppeteer-executor.js` 等文件到服务器：

```bash
# 在本地执行
scp /Users/yigongzhang/字节专用程序/截图套件/*.js root@<ECS公网IP>:/opt/puppeteer-executor/
```

#### Step 6: 启动服务

```bash
# 安装 PM2 进程管理器
npm install -g pm2

# 启动爬虫服务
pm2 start local-agent.js --name puppeteer-executor

# 设置开机自启
pm2 startup
pm2 save

# 查看日志
pm2 logs puppeteer-executor
```

### 计费预估（ECS）

| 项目 | 规格 | 年费用 | 月均 |
|------|------|--------|------|
| ECS 实例 | 2核4G | ¥89 | ¥7.4 |
| 系统盘 | 40GB SSD | 包含 | - |
| 公网带宽 | 按流量 | ~¥10-20/月 | ~¥15 |
| **合计** | | | **~¥22/月** |

### 滑块验证码处理

**触发频率**：约每 24 小时一次（不固定）

**解决方案**：集成打码平台（超级鹰）

| 平台 | 价格 | 特点 |
|------|------|------|
| **超级鹰** | ~¥0.01-0.03/次 | 老牌稳定，API 简单 |
| 图鉴 | ~¥0.01/次 | 便宜 |
| 若快 | ~¥0.02/次 | 速度快 |

**月成本预估**：~¥1（每天1次 × 30天 × ¥0.03）

**集成流程**：
```
1. Puppeteer 检测到滑块验证（页面出现特定元素）
      ↓
2. 截取滑块验证码图片
      ↓
3. 调用超级鹰 API，上传图片
      ↓
4. 平台返回滑动距离（如 "150" 像素）
      ↓
5. Puppeteer 模拟人类滑动（加速度曲线 + 随机抖动）
      ↓
6. 验证通过，继续执行原任务
```

**代码示例**（将集成到 puppeteer-executor.js）：
```javascript
async function solveSliderCaptcha(page) {
  // 检测是否有滑块
  const slider = await page.$('.captcha-slider');
  if (!slider) return true;

  // 截取验证码图片
  const captchaImage = await page.screenshot({
    clip: { x: 0, y: 0, width: 400, height: 200 }
  });

  // 调用超级鹰 API
  const distance = await callChaoJiYing(captchaImage.toString('base64'));

  // 模拟人类滑动
  await humanLikeSlide(page, slider, distance);

  return true;
}

async function callChaoJiYing(imageBase64) {
  const response = await fetch('http://upload.chaojiying.net/Upload/Processing.php', {
    method: 'POST',
    body: new URLSearchParams({
      user: process.env.CJY_USER,
      pass2: process.env.CJY_PASS_MD5,
      softid: process.env.CJY_SOFTID,
      codetype: '9101',  // 滑块类型
      file_base64: imageBase64
    })
  });
  const result = await response.json();
  return parseInt(result.pic_str);
}
```

**环境变量配置**：
```
CJY_USER=你的超级鹰用户名
CJY_PASS_MD5=密码的MD5值
CJY_SOFTID=软件ID（注册后获取）
```

### MVP 验证清单

- [x] 购买 ECS 实例（共享型 e-c1m2 2核4G，华东2上海，Ubuntu 22.04，5Mbps）✅ 2025-12-23
- [x] SSH 连接服务器（ECS Terminal） ✅ 2025-12-23
- [x] 系统更新 `apt update && apt upgrade -y` ✅ 2025-12-23
- [x] 安装 Node.js 20 ✅ 2025-12-23
- [x] 安装 Chromium 和中文字体 ✅ 2025-12-23
- [x] 创建项目目录 `/opt/puppeteer-executor` ✅ 2025-12-23
- [x] 安装 npm 依赖（puppeteer-core, sharp, @volcengine/tos-sdk, uuid, axios, mongodb, dotenv, express） ✅ 2025-12-23
- [x] **百度访问测试通过** ✅ 2025-12-23
- [x] **星图页面访问测试通过** ✅ 2025-12-23
- [x] **Mac SSH 快捷连接配置**（`ssh ecs`） ✅ 2025-12-23
- [x] 上传爬虫代码到服务器 ✅ 2025-12-23
- [x] 修改代码适配服务器环境（headless、Chrome路径、反检测补丁） ✅ 2025-12-23
- [x] 配置环境变量（MongoDB 内网连接、TOS） ✅ 2025-12-23
- [x] Cookie 登录态测试（从本地导出 Cookie 注入） ✅ 2025-12-23
- [x] **手动测试：执行"获取当日播放量"工作流** ✅ 2025-12-23 - 成功提取播放量 15,145,375
- [ ] PM2 启动爬虫服务（后台常驻）
- [ ] **超级鹰账号注册并充值**
- [ ] **滑块验证码自动处理测试**

### 已验证的关键能力

| 能力 | 状态 | 说明 |
|------|------|------|
| Chromium 无头模式 | ✅ 通过 | 可正常启动和截图 |
| 网络访问 | ✅ 通过 | 百度、星图均可访问 |
| 中文渲染 | ✅ 通过 | 截图中文字体正常 |
| SSH 远程管理 | ✅ 通过 | Mac 可直接 `ssh ecs` 连接 |
| **Cookie 登录态** | ✅ 通过 | 从本地 Chrome 导出 Cookie 注入服务器 |
| **反检测绕过** | ✅ 通过 | Stealth Patch 绕过星图 HTTP 444 反爬 |
| **数据提取** | ✅ 通过 | 成功提取播放量（15,145,375、1,692.14w 等） |
| **MongoDB 内网** | ✅ 通过 | 使用 `.ivolces.com` 内网地址连接 |
| **TOS 截图上传** | ✅ 通过 | 截图自动上传到火山引擎对象存储 |

### 服务器已安装环境

**路径**：`/opt/puppeteer-executor/`

**Node.js 版本**：v20.x（LTS，支持到 2026 年）

**已安装的 npm 依赖**：
```json
{
  "dependencies": {
    "puppeteer-core": "已安装",
    "sharp": "已安装（图片处理/长截图拼接）",
    "@volcengine/tos-sdk": "已安装（火山引擎对象存储）",
    "uuid": "已安装",
    "axios": "已安装",
    "mongodb": "已安装",
    "dotenv": "已安装",
    "express": "已安装"
  }
}
```

**服务器端核心文件**：
| 文件 | 说明 |
|------|------|
| `puppeteer-executor.js` | 主执行器（含反检测补丁） |
| `local-agent.js` | 任务轮询代理 |
| `cookie-loader.js` | Cookie 加载模块 |
| `xingtu-cookies.json` | 星图登录 Cookie（24个） |
| `.env` | 环境变量配置 |

**Chromium 路径**：`/usr/bin/chromium-browser`

**无头模式启动参数**（含反检测）：
```javascript
{
  executablePath: '/usr/bin/chromium-browser',
  headless: 'new',
  args: [
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu',
    '--disable-blink-features=AutomationControlled',  // 反检测
    '--disable-infobars',
    '--excludeSwitches=enable-automation'
  ]
}
```

### 关键技术方案

#### 1. Cookie 跨平台迁移方案

**问题**：Mac Chrome 的 Cookie 数据库是加密的，无法直接复制到 Linux 服务器使用。

**解决方案**：使用 Puppeteer API 导出 Cookie，而不是复制 Cookie 数据库文件。

**本地导出脚本** (`export-cookies.js`)：
```javascript
const puppeteer = require('puppeteer-core');
const fs = require('fs');

(async () => {
    const browser = await puppeteer.launch({
        executablePath: '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
        headless: true,
        userDataDir: './user_data_agent',  // 已登录的用户数据目录
    });
    const page = await browser.newPage();
    await page.goto('https://www.xingtu.cn', { waitUntil: 'networkidle2' });
    const cookies = await page.cookies('https://www.xingtu.cn');
    fs.writeFileSync('xingtu-cookies.json', JSON.stringify(cookies, null, 2));
    await browser.close();
})();
```

**服务器端注入**：
```javascript
const cookies = JSON.parse(fs.readFileSync('xingtu-cookies.json'));
await page.setCookie(...cookies);
```

#### 2. 反检测补丁（Stealth Patch）

**问题**：星图网站检测到 Headless 浏览器后返回 HTTP 444 错误，导致数据接口被拦截。

**解决方案**：在页面加载前注入反检测脚本，隐藏浏览器自动化特征。

**核心补丁内容**：
```javascript
async function applyStealthPatch(page) {
    // 设置真实 User-Agent
    await page.setUserAgent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...');

    // 注入反检测脚本
    await page.evaluateOnNewDocument(() => {
        // 隐藏 webdriver 属性
        Object.defineProperty(navigator, 'webdriver', { get: () => undefined });

        // 添加 Chrome 对象
        window.chrome = { runtime: {}, loadTimes: function() {}, csi: function() {}, app: {} };

        // 伪造 plugins、languages、hardwareConcurrency 等
        Object.defineProperty(navigator, 'plugins', { get: () => [...] });
        Object.defineProperty(navigator, 'languages', { get: () => ['zh-CN', 'zh', 'en-US', 'en'] });
    });

    // 设置视口
    await page.setViewport({ width: 1920, height: 1080, deviceScaleFactor: 2 });
}
```

#### 3. MongoDB 内网连接

**问题**：使用公网地址连接 MongoDB 会产生额外流量费用。

**解决方案**：ECS 与 MongoDB 在同一 VPC（VPC-5X2B），使用内网地址连接。

```
# 公网地址（有流量费）
mongodb://...mongodb.cn-shanghai.volces.com:3717

# 内网地址（免费）✅
mongodb://...mongodb.cn-shanghai.ivolces.com:3717
```

### Cookie 刷新流程（待实现）

当 Cookie 过期时，需要重新在本地登录并导出：

```bash
# 1. 本地执行（Mac）
cd /Users/yigongzhang/字节专用程序/截图套件
node export-cookies.js

# 2. 上传到服务器
scp xingtu-cookies.json ecs:/opt/puppeteer-executor/

# 3. 重启爬虫（如果使用 PM2）
ssh ecs "pm2 restart crawler"
```

---

## 阶段一：数据模型与基础 API

### 1.1 扩展 collaborations 集合（融合方案）

```javascript
// agentworks_db.collaborations 新增字段
{
  // ... 现有22个字段保持不变 ...

  // 新增：T7交付数据
  deliveryT7: {
    date: String,           // "2025-10-15"
    totalViews: Number,
    likeCount: Number,
    commentCount: Number,
    shareCount: Number,
    cpm: Number
  },

  // 新增：T21交付数据
  deliveryT21: {
    date: String,
    totalViews: Number,
    likeCount: Number,
    commentCount: Number,
    shareCount: Number,
    cpm: Number
  },

  // 新增：日报追踪数据
  dailyStats: [{
    date: String,           // "2025-10-08"
    totalViews: Number,
    cpm: Number,
    solution: String,       // 备注
    createdAt: Date
  }],

  // 新增：追踪状态
  trackingEnabled: Boolean,
  firstReportDate: String,
  lastReportDate: String
}

// 新增索引
db.collaborations.createIndex({ "dailyStats.date": 1 })
```

#### browser_sessions（云端登录态管理）

```javascript
// agentworks_db.browser_sessions
{
  _id: ObjectId,
  platform: 'douyin' | 'xiaohongshu' | 'bilibili' | 'kuaishou',
  accountLabel: String,

  cookies: {
    encrypted: String,
    iv: String,
    lastUpdated: Date
  },

  status: 'active' | 'expired' | 'pending_login',
  lastVerified: Date,
  expiresAt: Date,

  usageCount: Number,
  lastUsed: Date,
  failureCount: Number,

  createdBy: String,
  createdAt: Date,
  updatedAt: Date
}
```

#### automation_workflows（工作流配置 - 从 kol_data 迁移）

```javascript
// agentworks_db.automation_workflows
{
  _id: ObjectId,
  name: String,                    // "获取合作视频当日播放量"
  description: String,
  platform: 'douyin',              // 支持平台扩展
  requiredInput: {
    key: 'videoId' | 'taskId' | 'xingtuId',
    label: String
  },
  steps: [{
    action: 'goToURL' | 'waitForSelector' | 'click' | 'screenshot' |
            'wait' | 'scrollPage' | 'waitForNetworkIdle' | 'extractData' | 'compositeExtract',
    params: Object
  }],
  isActive: Boolean,
  createdAt: Date,
  updatedAt: Date
}
```

### 1.2 云函数清单

| 云函数名 | 职责 | 优先级 |
|---------|------|--------|
| `performanceApi` | 日报查询/写入 API（新建） | P0 |
| `automationWorkflows` | 工作流 CRUD（迁移） | P0 |
| `automationJobs` | 任务批管理（迁移） | P1 |
| `automationTasks` | 单任务管理（迁移） | P1 |
| `browserSessionManager` | Cookie 管理（新建） | P2 |
| `taskDispatcher` | 任务调度（线上化后） | P3 |

### 1.3 需要修改的文件

**云函数**
- `/functions/dataMigration/index.js` - 新增 migrateTracking 操作
- `/functions/getProjects/index.js` - 支持 trackingConfig 字段

**数据库 Schema**（新建）
- `/database/agentworks_db/schemas/collaboration_performance.schema.json`
- `/database/agentworks_db/schemas/browser_sessions.schema.json`
- `/database/agentworks_db/schemas/automation_workflows.schema.json`

---

## 阶段二：追踪数据迁移

### 2.1 迁移流程扩展

在现有 MigrationHome.tsx 的迁移步骤后新增：

```
选择项目 → 达人校验 → 项目迁移 → 合作迁移 → 效果迁移 → [追踪迁移] → 验收确认
                                                   ↑ 新增步骤
```

### 2.2 字段映射表

| kol_data.works | agentworks_db.collaboration_performance |
|----------------|----------------------------------------|
| `_id` | `legacyWorkId` |
| `collaborationId` | → 查找映射 → `collaborationId` |
| `talentId` | → 查找映射 → `talentOneId` |
| `t7_publishedAt` | `publishSnapshot.publishedAt` |
| `t7_totalViews` | `publishSnapshot.totalViews` |
| `dailyStats[]` | `dailyStats[]`（结构调整） |
| `dailyStats[].solution` | `dailyStats[].solution` |

### 2.3 需要修改的文件

**云函数**
- `/functions/dataMigration/index.js` - 新增 `migrateTracking` 操作

**前端**
- `/frontends/agentworks/src/pages/Migration/MigrationHome.tsx` - 新增"追踪迁移"步骤
- `/frontends/agentworks/src/api/dataMigration.ts` - 新增 API 类型

---

## 阶段三：追踪功能前端

### 3.1 功能架构

```
AgentWorks 导航
├── Projects (项目管理)
│   └── [ProjectDetail]
│       ├── OverviewTab (概览)
│       ├── CollaborationsTab (合作管理)
│       ├── ExecutionTab (执行追踪)
│       ├── TrackingTab (追踪监控) ← 新增
│       │   ├── 追踪配置（开关、时间维度）
│       │   ├── KPI 仪表板
│       │   ├── 日报数据表
│       │   └── 待录入提醒
│       └── FinancialTab (财务管理)
├── Reports (数据报表) ← 新增顶级模块
│   ├── DailyReport (日报总览)
│   │   ├── 跨项目视图
│   │   └── 报告生成器（一键生成图片）
│   └── PerformanceAnalysis (效果分析)
└── Automation (自动化管理) ← 新增
    ├── Jobs (任务批管理)
    ├── Workflows (工作流配置)
    └── Sessions (登录态管理)
```

### 3.2 项目级追踪配置

```typescript
interface ProjectTrackingConfig {
  enabled: boolean;
  trackingFrequency: 'daily' | 'weekly' | 'custom';
  customInterval?: number;
  startDate: Date;
  endDate?: Date;
  autoFetch: boolean;
  fetchTime?: string;
  kpiTargets: {
    cpm?: number;
    totalViews?: number;
  };
}
```

### 3.3 一键生成报告图片

核心功能：使用 html2canvas 将报告预览区域转换为图片，方便直接发给客户。

```typescript
<ReportGenerator>
  <ReportConfig>
    <Select label="选择项目" />
    <DateRangePicker label="报告周期" />
    <Checkbox.Group label="包含内容">
      <Checkbox value="kpi">KPI 汇总</Checkbox>
      <Checkbox value="trend">趋势图表</Checkbox>
      <Checkbox value="detail">视频明细</Checkbox>
    </Checkbox.Group>
  </ReportConfig>

  <ReportPreview ref={previewRef}>
    {/* 报告内容 */}
  </ReportPreview>

  <Button type="primary" onClick={handleGenerateImage}>
    一键生成图片
  </Button>
</ReportGenerator>
```

### 3.4 需要新建的文件

**前端页面**
- `pages/Projects/ProjectDetail/TrackingTab.tsx`
- `pages/Reports/DailyReport.tsx`
- `pages/Reports/ReportGenerator.tsx`
- `pages/Automation/AutomationHome.tsx`
- `pages/Automation/WorkflowEditor.tsx`
- `pages/Settings/BrowserSessions.tsx`

**前端组件**
- `components/tracking/TrackingConfigPanel.tsx`
- `components/tracking/KPIDashboard.tsx`
- `components/tracking/DailyReportTable.tsx`
- `components/tracking/TrendChart.tsx`
- `components/reports/ReportPreview.tsx`
- `components/common/KPICard.tsx`

**API 模块**
- `api/performance.ts`
- `api/browserSessions.ts`
- `api/tracking.ts`
- `api/automation.ts`

---

## 阶段四：自动化配置模块（复制 byteproject automation_suite）

### 4.1 参考现有实现

byteproject 的 automation_suite 包含：
- `constants.js` - 9 种 Action 类型定义
- `WorkflowBuilder.js` - 工作流可视化编辑器
- `TaskManager.js` - 任务管理面板
- `JobDashboard.js` - 任务批监控面板

### 4.2 Action 类型（保持一致）

```javascript
const ACTION_DEFINITIONS = {
  goToURL: { label: '打开网址', params: ['urlPattern'] },
  waitForSelector: { label: '等待元素', params: ['selector', 'timeout'] },
  click: { label: '点击', params: ['selector'] },
  screenshot: { label: '截图', params: ['name', 'fullPage'] },
  wait: { label: '等待', params: ['duration'] },
  scrollPage: { label: '滚动页面', params: ['distance'] },
  waitForNetworkIdle: { label: '等待网络', params: ['timeout'] },
  extractData: { label: '提取数据', params: ['fields'] },
  compositeExtract: { label: '复合提取', params: ['extractors'] }
};
```

### 4.3 现有工作流（需迁移）

| 工作流名称 | requiredInput.key | 用途 |
|-----------|-------------------|------|
| 获取合作视频当日播放量 | videoId | 日报数据抓取 |
| 获取合作视频14天后当日播放量 | videoId | 延迟日报抓取 |
| 达人主页全面报告 | xingtuId | 达人画像 |
| 达人数据获取 | xingtuId | 基础数据 |

### 4.4 需要新建的文件

**前端页面**
- `pages/Automation/AutomationHome.tsx` - 入口页面
- `pages/Automation/WorkflowList.tsx` - 工作流列表
- `pages/Automation/WorkflowEditor.tsx` - 工作流编辑器
- `pages/Automation/JobList.tsx` - 任务批列表
- `pages/Automation/JobDetail.tsx` - 任务批详情
- `pages/Automation/TaskDetail.tsx` - 单任务详情

**前端组件**
- `components/automation/ActionEditor.tsx` - 单步骤编辑
- `components/automation/StepList.tsx` - 步骤列表
- `components/automation/TaskStatusBadge.tsx` - 状态徽章
- `components/automation/JobProgressBar.tsx` - 进度条

---

## 阶段五：爬虫能力线上化（最复杂）

### 5.1 架构设计

```
┌────────────────────────────────────────────────────────────────┐
│                      AgentWorks 前端                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 自动化配置    │  │ 登录态管理   │  │ 日报监控     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
└─────────┼─────────────────┼─────────────────┼─────────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌────────────────────────────────────────────────────────────────┐
│                      云端服务层（veFaaS）                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ taskDispatcher│ │ browserSession│ │ performanceApi│         │
│  │ (定时触发)    │  │ Manager      │  │              │         │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘         │
└─────────┼─────────────────┼───────────────────────────────────┘
          │                 │
          ▼                 ▼
┌────────────────────────────────────────────────────────────────┐
│                  火山引擎 ECS 云服务器                          │
│  ┌────────────────────────────────────────────────────┐       │
│  │  Puppeteer 爬虫服务（PM2 管理）                     │       │
│  │  - Node.js + Chromium 环境                         │       │
│  │  - 轮询 MongoDB 获取待执行任务                     │       │
│  │  - 执行工作流，上传截图到 TOS                      │       │
│  │  - 集成超级鹰滑块验证处理                          │       │
│  │  - 可扩展：部署其他服务                            │       │
│  └────────────────────────────────────────────────────┘       │
│  月成本：~¥22（ECS ¥8 + 带宽 ¥15）                            │
└────────────────────────────────────────────────────────────────┘
```

### 5.2 核心云函数

| 云函数名 | 触发方式 | 职责 |
|---------|---------|------|
| `browserSessionManager` | HTTP | Cookie 管理（创建/验证/刷新） |
| `taskDispatcher` | 定时（1分钟） | 任务分发和调度 |
| `taskExecutor` | HTTP/队列 | 执行单个任务（调用容器服务） |
| `taskResultHandler` | 队列 | 处理执行结果，持久化数据 |
| `sessionHealthCheck` | 定时（1小时） | 检查 Cookie 有效性 |

### 5.3 Cookie 管理流程

```
用户操作                           系统处理
─────────                         ─────────
1. 点击"授权登录"
        ↓
2. 弹出浏览器窗口                  → 云端启动临时浏览器会话
   显示星图登录页
        ↓
3. 用户扫码登录
        ↓
4. 系统检测登录成功               → 提取 Cookie
        ↓
5. 显示"授权成功"                 → AES-256 加密存储
        ↓
6. 自动关闭窗口                   → 标记 session 为 active
```

### 5.4 需要新建的文件

**容器镜像**
- `/截图套件/docker/Dockerfile`
- `/截图套件/docker/executor.js`
- `/截图套件/docker/health-check.js`

**云函数**
- `/functions/browserSessionManager/index.js`
- `/functions/taskDispatcher/index.js`
- `/functions/taskExecutor/index.js`
- `/functions/taskResultHandler/index.js`

---

## 实施优先级总结

| 阶段 | 内容 | 依赖 | 复杂度 |
|------|------|------|--------|
| 1 | 数据模型与基础 API | 无 | 中 |
| 2 | 追踪数据迁移 | 阶段1 | 低 |
| 3 | 追踪功能前端 | 阶段1+2 | 中 |
| 4 | 自动化配置模块 | 阶段1 | 中 |
| 5 | 爬虫线上化 | 阶段1+4 | 高 |

**建议执行顺序**：
1. 先完成阶段 1+2，让数据能迁移过来
2. 并行开发阶段 3 和阶段 4
3. 最后完成阶段 5（爬虫线上化最复杂）

---

## 已确认的设计决策

| 决策项 | 选择 |
|--------|------|
| 浏览器服务 | **ECS 云服务器（包年 ¥89/年）** |
| 告警通知 | 前端页面提示 |
| 日报功能位置 | 项目详情 TrackingTab + 独立 Reports 模块 |
| byteproject | 保留运行 |
| 数据存储 | 融合到 collaborations 集合 |
| 自动化配置 | 复制 byteproject automation_suite 架构 |
| 滑块验证 | 超级鹰打码平台（~¥1/月） |
