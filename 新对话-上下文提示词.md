# ECS 浏览器崩溃问题排查 - 新对话上下文

> 创建时间：2025-12-27
> 目的：专门解决 ECS 上浏览器在截图步骤崩溃的问题

---

## 一、项目背景

我有一个**星图数据抓取自动化系统**，用于从抖音星图平台抓取达人数据。

系统有**两套执行环境**：
- **本地 Mac**：稳定可用，作为兜底方案
- **ECS 云服务器**：目前大部分功能已修复，但**浏览器会在截图步骤崩溃**

## 二、当前问题

### ❌ 核心问题：浏览器在执行截图时崩溃

**问题现象**：
任务在执行到"男女比例截图"（步骤 28/32）附近时，浏览器突然关闭：
```
[EXECUTOR] 执行动作 [28/32]: screenshot 男女比例截图
[EXECUTOR] 执行"普通截图"模式...
[EXECUTOR] 浏览器已关闭。  <-- 没有成功上传就崩溃了
[EXECUTOR] 浏览器已关闭，下次任务将启动新实例
[API] 工作流执行完成，耗时 61034ms
[SSE] 推送最终状态: taskId=xxx, status=failed
```

### 关键观察

| 观察点 | 情况 |
|--------|------|
| 崩溃位置 | 步骤 28/32 "男女比例截图" 附近 |
| 崩溃频率 | 不是每次都崩溃（前两个任务成功，第三个崩溃） |
| 内存状态 | 充足（14Gi 可用） |
| 系统 kill | 无（dmesg 无 OOM 记录） |
| 成功的达人 | 7211005162712727610（楠总不难） |
| 崩溃的达人 | 7053702605167394857（温暖一家） |

### 已排除的原因

- ❌ 不是内存不足（ECS 有 14Gi 可用内存）
- ❌ 不是被系统 OOM kill（dmesg 无记录）
- ❌ 不是 userDataDir 登录状态问题（已修复，headless 测试登录有效）
- ❌ 不是风控弹窗误判（已修复检测逻辑）

### 可能的原因

1. **截图操作本身的问题**
   - 截图时内存分配失败
   - 某些元素渲染导致 Chrome 崩溃
   - 截图选择器找不到元素

2. **特定达人页面的问题**
   - 某些达人页面有特殊元素导致渲染引擎崩溃
   - 页面 DOM 结构异常

3. **资源累积问题**
   - 连续执行多个任务后浏览器资源累积
   - 未正确释放的内存/句柄

4. **Puppeteer/Chrome 兼容性问题**
   - puppeteer-core 版本与 Chrome 版本不匹配
   - 某些 Chrome 功能在 headless 模式下有 bug

## 三、已解决的问题（本次会话）

### ✅ userDataDir 登录状态丢失

**原因**：之前反复调试更换浏览器（Chromium vs Chrome）导致 userDataDir 失效

**解决方案**：通过 VNC 在 ECS 上手动登录星图，重建有效的 userDataDir

### ✅ 风控弹窗误判

**原因**：`detectSliderCaptcha()` 检测逻辑过于宽泛

**解决方案**：增加风控关键词检查，只有包含特定关键词的弹窗才判定为风控

## 四、技术栈

### ECS 服务器

```
服务器: root@14.103.18.8
密码: 64223902Kz
目录: /opt/puppeteer-executor/

核心文件：
├── puppeteer-executor.js  # v23.0 核心执行器（1115行）
├── task-server.js         # v3.0 HTTP API 服务
├── vnc-manager.js         # VNC 管理
├── cookie-loader.js       # Cookie 注入
├── user_data_agent/       # 浏览器状态缓存（登录态）
└── .env                   # 环境变量（TOS、MongoDB 配置）

PM2 进程：
- puppeteer-agent (id: 0) - 轮询代理
- scheduler (id: 1) - 调度器
- task-server (id: 2) - HTTP API（端口 3001）

Chrome 版本：143.0.7499.169
Node.js 版本：20.19.6
```

### 截图相关代码位置

截图功能在 `puppeteer-executor.js` 中，关键函数：
- `executeActions()` - 执行工作流步骤
- 截图操作类型：`screenshot`
- 有"普通截图"和"分段式智能裁剪"两种模式

## 五、复现步骤

1. 访问 AgentWorks 前端：http://localhost:5175/
2. 进入项目 → 合作达人 → 选择一个达人
3. 使用"抖商报名表"工作流执行截图任务
4. 观察任务执行到步骤 28/32 附近是否崩溃

## 六、相关日志命令

```bash
# SSH 连接 ECS
sshpass -p '64223902Kz' ssh root@14.103.18.8

# 查看 task-server 日志
pm2 logs task-server --lines 200

# 查看系统日志（是否有 OOM kill）
dmesg -T | grep -i "chrome\|oom\|killed"

# 检查内存状态
free -h

# 检查 Chrome 进程
ps aux | grep google-chrome
```

## 七、需要排查的方向

1. **增加错误捕获**
   - 在截图操作前后添加 try-catch
   - 捕获 Chrome 崩溃时的具体错误信息
   - 添加更详细的日志输出

2. **分析崩溃模式**
   - 对比成功和失败的达人页面 DOM 差异
   - 检查崩溃时的内存使用情况
   - 分析是否与特定页面元素有关

3. **增加重试机制**
   - 截图失败时自动重试
   - 浏览器崩溃时重新启动

4. **检查 Puppeteer 配置**
   - 浏览器启动参数是否合理
   - 是否需要增加 `--disable-dev-shm-usage` 等参数
   - headless 模式配置

## 八、关键文件路径

### 需要读取的文件

```
ECS 上：
/opt/puppeteer-executor/puppeteer-executor.js  # 核心执行器

本地文档：
/Users/yigongzhang/字节专用程序/截图套件/ECS-本地技术差异分析.md
/Users/yigongzhang/字节专用程序/截图套件/ECS-操作说明.md
```

## 九、重要说明

1. **这不是偶发问题**：之前的对话就是因为这个问题反复找不到核心原因，更新了无数版本的浏览器，导致 userDataDir 丢失
2. **不要轻易修改浏览器配置**：已经因为乱改导致过问题
3. **先分析再修改**：请先充分分析日志和代码，确定根本原因后再修改

## 十、目标

1. **找出浏览器崩溃的根本原因**
2. **实现可靠的错误处理和重试机制**
3. **确保截图任务能稳定完成**

---

请先阅读 `ECS-本地技术差异分析.md` 了解完整背景，然后帮我排查浏览器崩溃问题。
