# 待办 & 开发计划

> 最后更新：2025-12-26

---

## 当前焦点：ECS vs 本地执行决策

**状态**：决策中

详细分析见 [ECS-本地技术差异分析.md](./ECS-本地技术差异分析.md)

### 问题总结

| 问题 | 状态 | 说明 |
|------|------|------|
| 验证码误检测 | 已修复 | 增加了可见性检查 |
| page null 错误 | 已修复 | 增加了有效性检查 |
| 选择器超时 | 待排查 | v23.0 代码可能有 bug |
| 手机验证码 | 无法修复 | 机房 IP 被风控 |

### 推荐方案

**本地执行 + Cloudflare Tunnel**
- 使用住宅 IP，风控概率低
- 保留前端远程触发能力
- 代码改动最小

---

## 已完成

### Cloudflare Tunnel HTTPS 配置（2024-12-24 完成）

**问题**：Cloudflare Pages 部署的前端无法访问 ECS API（HTTPS 页面不能请求 HTTP 资源）

**解决方案**：使用 Cloudflare Tunnel 临时隧道提供 HTTPS 访问

**当前配置**：
```
ECS API 地址（HTTPS）: https://aaron-calls-calcium-leather.trycloudflare.com
原始地址（HTTP）: http://14.103.18.8:3001

PM2 服务:
- task-server: HTTP API 服务（端口 3001）
- cloudflared: Cloudflare Tunnel 进程
```

**注意事项**：
- 临时隧道 URL 在 ECS 重启或 cloudflared 重启后会**变化**
- URL 变化时需要更新前端代码：`src/api/automation.ts` 中的 `ECS_API_BASE_URL`
- 长期稳定方案：购买域名（Cloudflare 注册 .xyz 约 $1/年）托管到 Cloudflare

**相关命令**：
```bash
# 查看当前 tunnel URL
pm2 logs cloudflared --lines 20 | grep trycloudflare.com

# 重启 tunnel（会生成新 URL）
pm2 restart cloudflared
```

---

### ID 架构优化（2024-12-24 完成）

**问题**：AgentWorks 达人数据中，星图ID 存储在两个位置导致数据不一致

**解决方案**：
1. ✅ 修改 `workflow.ts` 中 `xingtuId.idField` 为 `platformAccountId`
2. ✅ 清理数据库中 440 条冗余的 `platformSpecific.xingtuId` 字段
3. ✅ 在 ECS `puppeteer-executor.js` 文件头添加 ID 架构说明

**最终架构**：
```
AgentWorks 达人数据:
├── platformAccountId: "7069698789983911971"  ← 星图ID（必填，所有达人都有）
└── platformSpecific:
    └── uid: "827303091503240"                ← 抖音UID（可选附加信息）

工作流执行时:
AgentWorks 从 talent.platformAccountId 获取值
  → 传给 ECS: { xingtuId: "xxx" }
  → ECS 替换 {{xingtuId}} 变量
```

---

## 待开发

### P0 - 高优先级

#### ~~1. 工作流管理页面优化~~（2024-12-24 完成）

**文件**: `src/pages/Automation/Workflows/WorkflowList.tsx`

**完成情况**:
- [x] 移除 3 个渐变统计卡片（已改为 ProTable 形式）
- [x] 将统计信息移至表格 headerTitle
- [x] 添加 Select 平台筛选下拉
- [x] 简化为 ProTable 布局（v3.1.0）

#### ~~2. ECS VNC 模式问题排查~~（2025-12-26 暂停）

**问题**：VNC 模式下处理完验证码后任务仍然失败

**已修复**：
- [x] 验证码误检测（增加可见性检查）
- [x] page null 错误（增加有效性检查）

**待解决**：
- [ ] 选择器超时（可能是 v23.0 代码改坏了）
- [ ] 手机验证码（机房 IP 被风控，无法解决）

**决策**：暂停 ECS 修复，转向本地执行 + 远程触发方案

---

#### 4. 达人详情页集成工作流执行

**思路**:
- 在达人详情页添加「爬取数据」按钮
- 自动填充 `platformAccountId` 作为 `xingtuId` 参数
- 支持选择工作流类型（达人主页报告等）

**涉及文件**:
- `src/pages/Talents/TalentDetail/TalentDetail.tsx`
- `src/components/automation/WorkflowExecuteModal.tsx`

**开发时提示词**（复制给 Claude）:
```
我要在达人详情页添加「爬取数据」按钮，点击后自动执行工作流。

相关设计：
- WORKFLOW_INPUT_CONFIGS 在 src/types/workflow.ts 中定义了 idField
- idField 用于指定从达人/合作记录的哪个字段自动取值
- xingtuId 的 idField 是 'platformAccountId'（从 talent.platformAccountId 取值）
- taskId/videoId 的 idField 对应合作记录字段（从 collaboration.taskId/videoId 取值）

参考 ByteProject 的实现：
- frontends/byteproject/project_automation/modal-automation.js
- 第 137-146 行：从 collab 数据中取 xingtuId 和 taskId

请先读取 截图套件/待办-开发计划.md 了解完整的 ID 架构设计。
```

#### 5. 日报数据迁移

**思路**:
- 将 ByteProject 的日报数据迁移到 AgentWorks
- 设计新的日报数据模型
- 创建日报查看/编辑页面

---

### P1 - 中优先级

#### 6. 滑块验证自动处理

**问题**: 星图登录可能触发滑块验证，导致 Cookie 失效

**方案选择**:
- A. 超级鹰 API 自动识别（成本约 0.01 元/次）【推荐】
- B. 本地手动处理后刷新 Cookie

**涉及文件**:
- `refresh-cookie.js` - 本地刷新脚本
- `puppeteer-executor.js` - 检测滑块并暂停

**星图滑块验证码 DOM 结构**（2024-12-24 采集）:

```html
<!-- 滑块验证容器 -->
<div id="captcha_container">
  <div id="vc_captcha_box" style="font-size: 100px;">
    <div class="vc-captcha-verify slide">
      <div class="vc-captcha-verify-visibility" style="visibility: visible;">
        <!-- 关闭按钮 -->
        <div role="button" class="vc-captcha-close-btn captcha_verify_bar--close"></div>

        <!-- 验证码标题栏 -->
        <div class="captcha-bar captcha_verify_bar">
          <div class="tit captcha_verify_bar--title svelte-acemma" tabindex="1"></div>
        </div>

        <!-- 验证码图片区域 -->
        <div class="verify-image captcha_verify_img--wrapper">
          <!-- 背景大图（需要截图发给打码平台） -->
          <img class="captcha-verify-image"
               src="https://p3-catpcha.byteimg.com/tos-cn-i-188rlo5p4y/xxx~tplv-188rlo5p4y-2.jpeg"
               alt="basicImg"
               id="captcha_verify_image"
               crossorigin="anonymous">
          <canvas id class="captcha-verify-image" draggable="false">

          <!-- 滑块拖动区域 -->
          <div class="dragger-box" style="position: absolute; top: 0.578...em;">
            <div class="dragger-item" style="transform: translateX(0px)">
              <!-- 滑块小图 -->
              <img id="captcha_verify_img_slide"
                   class="captcha-verify-image-slide"
                   src="https://p3-catpcha.byteimg.com/tos-cn-i-188rlo5p4y/xxx~tplv-188rlo5p4y-1.png"
                   alt="actionImg"
                   crossorigin="anonymous"
                   slot="dragger">
            </div>
          </div>
        </div>

        <!-- 滑块按钮（需要拖动的元素） -->
        <div class="captcha-slider captcha_verify_slide--button"></div>

        <!-- 底部信息 -->
        <div id="footer-wrap-row" class="svelte-zniw7"></div>
      </div>
    </div>
  </div>
</div>

<!-- 验证码 JS 脚本 -->
<script src="https://lf-cdn-tos.bytescm.com/obj/rc-verifycenter/rmc-captcha/1.0.0.729/captcha.js"></script>
```

**关键选择器**:

| 用途 | 选择器 | 说明 |
|------|--------|------|
| **检测滑块出现** | `#captcha_container` | 容器存在即表示需要验证 |
| **验证类型** | `.vc-captcha-verify.slide` | 确认是滑块类型 |
| **背景图** | `#captcha_verify_image` | 需截图发给超级鹰 |
| **滑块图** | `#captcha_verify_img_slide` | 小滑块图片 |
| **滑块按钮** | `.captcha-slider.captcha_verify_slide--button` | 需要拖动 |
| **关闭按钮** | `.vc-captcha-close-btn` | 关闭验证弹窗 |

**图片 URL 规律**:
- 背景图: `https://p3-catpcha.byteimg.com/tos-cn-i-188rlo5p4y/{hash}~tplv-188rlo5p4y-2.jpeg`
- 滑块图: `https://p3-catpcha.byteimg.com/tos-cn-i-188rlo5p4y/{hash}~tplv-188rlo5p4y-1.png`

**待补充信息**（下次滑块出现时采集）:

| 信息 | 用途 | 采集方式 |
|------|------|----------|
| 滑块轨道宽度 | 计算滑动距离比例 | 开发者工具查看 `.captcha-slider` 宽度 |
| 背景图尺寸 | 发给超级鹰的图片尺寸 | 右键图片 → 查看图片信息 |
| 滑块图尺寸 | 计算滑块宽度占比 | 同上 |
| 验证成功后变化 | 判断是否需要重试 | 滑动成功后观察 DOM 变化 |
| 验证失败后变化 | 判断失败状态 | 故意滑错后观察 DOM 变化 |

**实现步骤**（待开发）:
1. 在 `puppeteer-executor.js` 中添加滑块检测函数
2. 检测到滑块时：截图 + 保存 HTML + 记录日志
3. 集成超级鹰 API（需注册账号）
4. 实现模拟人类滑动（加速度曲线 + 随机抖动）

#### 7. 执行失败自动重试

**思路**:
- task-server 添加重试逻辑
- 最多重试 3 次，间隔递增（1s, 3s, 10s）
- 记录失败原因到数据库

**涉及文件**:
- `/opt/puppeteer-executor/task-server.js`

---

### P2 - 低优先级

#### 8. 告警通知

**思路**:
- Cookie 过期时发送飞书/邮件通知
- 连续执行失败时告警

#### 9. 多平台扩展

**思路**:
- 支持小红书蒲公英平台
- 复用现有工作流架构，添加 `platform: 'xiaohongshu'`

---

## 架构决策记录

### 决策 1: ID 字段统一使用 platformAccountId

**日期**: 2024-12-24

**背景**:
- `platformAccountId` 是表单必填字段，所有达人都有
- `platformSpecific.xingtuId` 是历史迁移产物，新达人没有

**决策**:
- 工作流配置中 `idField` 统一指向 `platformAccountId`
- `platformSpecific` 只存放非必填的额外信息（如 uid）
- 删除冗余的 `platformSpecific.xingtuId`

**影响**:
- ByteProject 不受影响（直接传参数）
- AgentWorks 工作流正常工作
- 新达人也能正常执行工作流

### 决策 2: 工作流数据存储在 agentworks_db

**日期**: 2024-12-24

**背景**:
- ByteProject 使用 `kol_data.automation-workflows`
- AgentWorks 使用 `agentworks_db.automation-workflows`

**决策**:
- AgentWorks 前端连接 `agentworks_db`
- ECS 服务器通过 API 获取工作流，不直接读数据库
- 两套系统的工作流数据独立管理

---

## 参考文件

| 文件 | 说明 |
|------|------|
| `/Users/yigongzhang/.claude/plans/federated-churning-puddle.md` | 完整开发计划 |
| `src/types/workflow.ts` | 工作流类型定义 |
| `src/pages/Automation/Workflows/` | 工作流管理页面 |
| `/opt/puppeteer-executor/puppeteer-executor.js` | ECS 核心执行器 |
| `/opt/puppeteer-executor/task-server.js` | ECS HTTP API |
